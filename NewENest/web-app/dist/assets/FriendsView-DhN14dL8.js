import{M as e,r as a,c as s,d as t,j as l,a as n,b as i,e as r,w as u,f as d,o as c,h as o,k as v,s as m,n as f,F as p,q as y,t as g,p as h,D as _,O as w,B as k,P as q,A as x,C as b,g as C,Q as R,E as V,L as F,K as z}from"./index-DxIqJ1ay.js";import{a as j,u as U}from"./userStore--b81hqFJ.js";import{_ as $}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./index-rSMZb3Ae.js";const I=async()=>(await j.get("/friends")).data,A=async()=>(await j.get("/friends/requests")).data,M=async e=>{var a,s;try{return await j.post("/friends/requests",{receiver_id:e}),{success:!0}}catch(t){return{success:!1,message:(null==(s=null==(a=t.response)?void 0:a.data)?void 0:s.message)||"发送好友请求失败，请稍后再试"}}},P=async e=>{var a,s;try{return await j.post("/friends/requests/response",{request_id:e,action:"accept"}),{success:!0}}catch(t){return{success:!1,message:(null==(s=null==(a=t.response)?void 0:a.data)?void 0:s.message)||"接受好友请求失败，请稍后再试"}}},T=async e=>{var a,s;try{return await j.post("/friends/requests/response",{request_id:e,action:"reject"}),{success:!0}}catch(t){return{success:!1,message:(null==(s=null==(a=t.response)?void 0:a.data)?void 0:s.message)||"拒绝好友请求失败，请稍后再试"}}},B=async e=>{var a,s;try{return await j.delete(`/friends/${e}`),{success:!0}}catch(t){return{success:!1,message:(null==(s=null==(a=t.response)?void 0:a.data)?void 0:s.message)||"删除好友失败，请稍后再试"}}},D=async e=>(await j.get(`/users/search?keyword=${encodeURIComponent(e)}`)).data,K=async(e,a=1,s=20)=>(await j.get(`/friends/${e}/messages`,{params:{page:a,pageSize:s}})).data,L=async(e,a,s="text")=>(await j.post("/friends/messages",{receiver_id:e,message_type:s,content:a})).data,S=e("friend",(()=>{const e=a([]),t=a([]),l=a(!1),n=a([]),i=a(!1),r=s((()=>e.value.length)),u=s((()=>t.value.length)),d=s((()=>r.value>0)),c=s((()=>u.value>0));async function o(){try{l.value=!0;const a=await I();e.value=a}catch(a){}finally{l.value=!1}}async function v(){try{l.value=!0;const e=await A();t.value=e}catch(e){}finally{l.value=!1}}return{friends:e,friendRequests:t,loading:l,searchResults:n,searchLoading:i,friendCount:r,pendingRequestCount:u,hasFriends:d,hasPendingRequests:c,loadFriends:o,loadFriendRequests:v,sendFriendRequest:async function(e){return await M(e)},acceptFriendRequest:async function(e){const a=await P(e);return a.success&&(t.value=t.value.filter((a=>a.id!==e)),await o()),a},rejectFriendRequest:async function(e){const a=await T(e);return a.success&&(t.value=t.value.filter((a=>a.id!==e))),a},deleteFriend:async function(a){const s=await B(a);return s.success&&(e.value=e.value.filter((e=>e.friendship_id!==a))),s},searchUsers:async function(e){if(e.trim())try{i.value=!0;const a=await D(e);n.value=a}catch(a){n.value=[]}finally{i.value=!1}else n.value=[]},initialize:async function(){await Promise.all([o(),v()])}}})),E={class:"friends-view"},H={class:"page-header"},N={class:"friends-list"},O={class:"friend-item-skeleton"},Q={style:{flex:"1","margin-left":"16px"}},G={key:0,class:"friend-list-content"},J={class:"friend-info"},W={class:"friend-name"},X={class:"friend-meta"},Y={class:"study-time"},Z={key:0},ee={key:0,class:"friend-signature"},ae={class:"friend-actions"},se={class:"friend-requests-list"},te={class:"request-info"},le={class:"request-name"},ne={class:"request-time"},ie={class:"request-actions"},re={class:"search-results"},ue={key:0},de={class:"user-info"},ce={class:"user-name"},oe={class:"user-email"},ve={class:"user-actions"},me={key:2,class:"search-tip"},fe={class:"chat-container"},pe={class:"message-content"},ye={class:"message-time"},ge={key:0,class:"empty-chat"},he={class:"chat-input"},_e=$(t({__name:"FriendsView",setup(e){const t=U(),j=S(),$=a("friends"),I=a(!1),A=a(!1),M=a(""),P=a(""),T=a(null),B=a([]),D=a(null),_e=s((()=>{var e;return(null==(e=t.userInfo)?void 0:e.id)||0})),we=s((()=>j.loading)),ke=s((()=>j.friends)),qe=s((()=>j.friendRequests)),xe=s((()=>j.hasFriends)),be=s((()=>j.hasPendingRequests)),Ce=s((()=>j.searchResults)),Re=s((()=>j.searchLoading));l((async()=>{await j.initialize(),be.value&&($.value="requests")}));const Ve=()=>{I.value=!0,M.value="",j.searchResults=[]},Fe=()=>{M.value.trim()&&j.searchUsers(M.value)},ze=e=>{F.confirm(`确定要删除好友 ${e.username} 吗？`,"删除好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{const a=await j.deleteFriend(e.friendship_id);a.success?V.success("好友已删除"):V.error(a.message)})).catch((()=>{}))},je=async()=>{if(P.value.trim()&&T.value)try{const e=await L(T.value.id,P.value);B.value.push(e),P.value="",await z(),Ue()}catch(e){V.error("发送消息失败")}},Ue=()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)},$e=e=>{const a=Math.floor(e/3600),s=Math.floor(e%3600/60);return a>0?`${a}小时${s}分钟`:`${s}分钟`},Ie=e=>{const a=new Date(e);return new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(a)};return(e,a)=>{var s;const t=d("el-icon"),l=d("el-button"),F=d("el-skeleton-item"),U=d("el-skeleton"),L=d("el-avatar"),S=d("el-badge"),Ae=d("el-dropdown-item"),Me=d("el-dropdown-menu"),Pe=d("el-dropdown"),Te=d("el-empty"),Be=d("el-tab-pane"),De=d("el-tabs"),Ke=d("el-input"),Le=d("el-form-item"),Se=d("el-form"),Ee=d("el-dialog"),He=x("loading");return c(),n("div",E,[i("div",H,[a[6]||(a[6]=i("h1",null,"好友管理",-1)),r(l,{type:"primary",onClick:Ve},{default:u((()=>[r(t,null,{default:u((()=>[r(v(m))])),_:1}),a[5]||(a[5]=o(" 添加好友 "))])),_:1})]),r(De,{modelValue:$.value,"onUpdate:modelValue":a[0]||(a[0]=e=>$.value=e),class:"friends-tabs"},{default:u((()=>[r(Be,{label:"好友列表",name:"friends"},{default:u((()=>[i("div",N,[we.value?(c(),f(U,{key:0,loading:we.value,animated:"",count:3},{template:u((()=>[i("div",O,[r(F,{variant:"circle",style:{width:"40px",height:"40px"}}),i("div",Q,[r(F,{variant:"text",style:{width:"30%"}}),r(F,{variant:"text",style:{width:"50%","margin-top":"8px"}})])])])),_:1},8,["loading"])):(c(),n(p,{key:1},[xe.value?(c(),n("div",G,[(c(!0),n(p,null,y(ke.value,(e=>(c(),n("div",{key:e.id,class:"friend-item"},[r(L,{src:e.avatar,size:40},{default:u((()=>[o(g(e.username.charAt(0)),1)])),_:2},1032,["src"]),i("div",J,[i("div",W,g(e.username),1),i("div",X,[i("span",Y,"累计学习："+g($e(e.total_study_time)),1),e.study_direction?(c(),n("span",Z,"方向："+g(e.study_direction),1)):h("",!0)]),e.signature?(c(),n("div",ee,g(e.signature),1)):h("",!0)]),i("div",ae,[r(S,{value:e.unread_messages,hidden:0===e.unread_messages,type:"danger"},{default:u((()=>[r(l,{size:"small",type:"primary",onClick:a=>(async e=>{T.value=e,A.value=!0,P.value="",B.value=[];try{const a=await K(e.id);B.value=a.messages||[],await z(),Ue()}catch(a){V.error("获取聊天记录失败")}})(e),plain:""},{default:u((()=>[r(t,null,{default:u((()=>[r(v(_))])),_:1}),a[7]||(a[7]=o(" 聊天 "))])),_:2},1032,["onClick"])])),_:2},1032,["value","hidden"]),r(Pe,{trigger:"click",onCommand:a=>((e,a)=>{switch(e){case"study":V.info("邀请学习功能即将上线");break;case"contract":V.info("学习契约功能即将上线");break;case"delete":ze(a)}})(a,e)},{dropdown:u((()=>[r(Me,null,{default:u((()=>[r(Ae,{command:"study"},{default:u((()=>a[8]||(a[8]=[o("一起学习")]))),_:1}),r(Ae,{command:"contract"},{default:u((()=>a[9]||(a[9]=[o("创建契约")]))),_:1}),r(Ae,{command:"delete",divided:""},{default:u((()=>a[10]||(a[10]=[o("删除好友")]))),_:1})])),_:1})])),default:u((()=>[r(l,{size:"small",plain:""},{default:u((()=>[r(t,null,{default:u((()=>[r(v(w))])),_:1})])),_:1})])),_:2},1032,["onCommand"])])])))),128))])):(c(),f(Te,{key:1,description:"暂无好友"}))],64))])])),_:1}),r(Be,{label:"好友请求",name:"requests",disabled:!be.value},{default:u((()=>[i("div",se,[(c(!0),n(p,null,y(qe.value,(e=>(c(),n("div",{key:e.id,class:"request-item"},[r(L,{src:e.avatar,size:40},{default:u((()=>[o(g(e.username.charAt(0)),1)])),_:2},1032,["src"]),i("div",te,[i("div",le,g(e.username),1),i("div",ne,g(Ie(e.created_at)),1)]),i("div",ie,[r(l,{size:"small",type:"success",onClick:a=>(async e=>{const a=await j.acceptFriendRequest(e);a.success?V.success("已接受好友请求"):V.error(a.message)})(e.id),plain:""},{default:u((()=>a[11]||(a[11]=[o("接受")]))),_:2},1032,["onClick"]),r(l,{size:"small",type:"danger",onClick:a=>(async e=>{const a=await j.rejectFriendRequest(e);a.success?V.success("已拒绝好友请求"):V.error(a.message)})(e.id),plain:""},{default:u((()=>a[12]||(a[12]=[o("拒绝")]))),_:2},1032,["onClick"])])])))),128)),0===qe.value.length?(c(),f(Te,{key:0,description:"暂无好友请求"})):h("",!0)])])),_:1},8,["disabled"])])),_:1},8,["modelValue"]),r(Ee,{modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=e=>I.value=e),title:"添加好友",width:"500px"},{default:u((()=>[r(Se,null,{default:u((()=>[r(Le,null,{default:u((()=>[r(Ke,{modelValue:M.value,"onUpdate:modelValue":a[1]||(a[1]=e=>M.value=e),placeholder:"搜索用户名或邮箱",clearable:"",onInput:Fe,"suffix-icon":v(q)},null,8,["modelValue","suffix-icon"])])),_:1})])),_:1}),k((c(),n("div",re,[Ce.value.length>0?(c(),n("div",ue,[(c(!0),n(p,null,y(Ce.value,(e=>(c(),n("div",{key:e.id,class:"search-result-item"},[r(L,{src:e.avatar,size:40},{default:u((()=>[o(g(e.username.charAt(0)),1)])),_:2},1032,["src"]),i("div",de,[i("div",ce,g(e.username),1),i("div",oe,g(e.email),1)]),i("div",ve,[r(l,{size:"small",type:"primary",disabled:e.is_friend,onClick:a=>(async e=>{const a=await j.sendFriendRequest(e);if(a.success){V.success("好友请求已发送");const a=Ce.value.findIndex((a=>a.id===e));-1!==a&&(Ce.value[a].is_friend=!0)}else V.error(a.message)})(e.id),plain:""},{default:u((()=>[o(g(e.is_friend?"已是好友":"添加"),1)])),_:2},1032,["disabled","onClick"])])])))),128))])):!Re.value&&M.value?(c(),f(Te,{key:1,description:"未找到相关用户"})):Re.value||M.value?h("",!0):(c(),n("div",me," 请输入用户名或邮箱进行搜索 "))])),[[He,Re.value]])])),_:1},8,["modelValue"]),r(Ee,{modelValue:A.value,"onUpdate:modelValue":a[4]||(a[4]=e=>A.value=e),title:`与 ${(null==(s=T.value)?void 0:s.username)||""} 的聊天`,width:"600px"},{default:u((()=>[i("div",fe,[i("div",{class:"chat-messages",ref_key:"chatMessagesRef",ref:D},[(c(!0),n(p,null,y(B.value,((e,a)=>(c(),n("div",{key:a,class:b(["message-item",{"message-self":e.sender_id===_e.value}])},[i("div",pe,g(e.content),1),i("div",ye,g($e(e.created_at)),1)],2)))),128)),0===B.value.length?(c(),n("div",ge,[r(Te,{description:"暂无消息记录"})])):h("",!0)],512),i("div",he,[r(Ke,{modelValue:P.value,"onUpdate:modelValue":a[3]||(a[3]=e=>P.value=e),type:"textarea",rows:2,placeholder:"输入消息...",onKeydown:C(R(je,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),r(l,{type:"primary",onClick:je,disabled:!P.value.trim()},{default:u((()=>a[13]||(a[13]=[o(" 发送 ")]))),_:1},8,["disabled"])])])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-eb9395d8"]]);export{_e as default};
